# ST-Statistics（SillyTavern 聊天统计扩展）

面向 SillyTavern 的聊天统计与可视化扩展，提供清晰直观的聊天分析面板。

## 主要功能

### 📊 核心统计
- **统计概览**：用户/AI 消息数、字数、Token 等关键指标
- **模型统计**：AI 回复所使用的模型占比分析（饼图展示）
- **角色排序**：全局模式下，各角色的聊天消息量排名
- **对比分析**：用户与 AI 的消息数、字数对比

### 📈 时间维度
- **每日活跃度**：从开始至今的聊天活跃趋势（柱状图）
- **24 小时分布**：全天时段活跃热力图与趋势折线
- **时长统计**：
  - 总时长仪表盘（半圆规）
  - 每日时长柱状图（基于消息内容推算）

### 🎨 用户界面
- **主题切换**：内置 5 种配色方案（紫色、蓝色、翠绿色、琥珀色、玫瑰色），一键切换
- **响应式设计**：适配各种屏幕尺寸
- **日期范围筛选**：灵活选择统计时间范围
- **一键导出**：将统计面板保存为 PNG 图片

### 💾 数据管理
- **智能缓存**：同一角色的统计结果缓存，减少重复计算
- **多层备份**：SillyTavern 设置 + localStorage 双重持久化
- **自动清理**：可配置缓存过期清理，防止数据堆积

## 安装

### 方式一：直接复制
1. 克隆或下载本仓库
2. 将文件夹复制到 SillyTavern 的扩展目录：
   ```
   SillyTavern/public/scripts/extensions/ST-Statistics/
   ```
3. 重启 SillyTavern

### 方式二：Git 克隆
```bash
cd SillyTavern/public/scripts/extensions
git clone https://github.com/Youzini-afk/ST-Statistics.git
```

## 使用方法

### 基础统计
1. 在 SillyTavern 中选择角色
2. 点击页面右下方的魔法棒图标，打开扩展菜单
3. 在"聊天统计"面板中选择：
   - **当前角色统计**：仅统计当前选中角色的聊天
   - **全部角色统计**：统计所有角色的聊天（全局模式）
4. 等待分析完成，查看统计面板

### 日期范围筛选
1. 在统计面板中找到"日期范围"选项
2. 设置开始日期和结束日期
3. 点击"应用"按钮，重新计算指定时间范围的统计

### 主题切换
- 点击统计面板右上方的"切换配色"按钮，循环切换 5 种主题

### 导出图片
- 点击"导出图片"按钮，自动截图并下载为 PNG 文件
- 可用于分享或存档

### 缓存清理
在扩展设置中可配置：
- **自动清理缓存**：启用/禁用自动清理
- **保留天数**：设置缓存保留期限（1-365 天）
- **立即清理**：手动触发缓存清理

## 统计口径说明

### 消息统计
- **用户消息数**：所有用户发送的消息条数
- **AI 消息数**：所有 AI 生成的回复条数
- **消息比例**：AI消息数 / 用户消息数

### 字数统计
- **用户输入字数**：用户所有消息的总字符数
- **AI 输出字数**：AI 所有回复的总字符数

### Token 统计
- **用户 Token**：按用户输入字数估算
  - 中文：1.5 字/Token
  - 英文：3.5 字/Token
- **AI Token**：优先使用消息记录中的实际 Token 计数，无则使用上述估算方式

### 时长统计
**核心算法**：基于消息内容的交互时间估算
- **用户消息**：根据字数估算打字时间
  - 中文：60 字/分钟
  - 英文：200 字/分钟
- **AI 消息**：根据字数估算阅读时间
  - 中文：400 字/分钟
  - 英文：800 字/分钟
- **会话间隔**：连续消息间隔 ≤ 30 分钟视为同一会话，> 30 分钟则开启新会话
- **最小时长**：每个会话至少计 1 分钟

**示例**：
- 用户输入 60 个中文字 → 1 分钟
- AI 回复 400 个中文字 → 1 分钟
- 若两条消息间隔 5 分钟 → 继续同会话累加
- 若间隔 40 分钟 → 开启新会话

### 日期统计
- 所有"按天"的统计基于**本地时区**计算
- 不受 UTC 时区影响

## 开发与构建

### 环境要求
- Node.js 14+
- npm 或 yarn

### 快速开始
```bash
# 安装依赖
npm install

# 开发模式（监听变更）
npm run dev

# 生产构建
npm run build
```

### 项目结构
```
src/
├── index.js          # 扩展入口、事件绑定、缓存管理
├── analyzer.js       # 统计计算、数据分析核心
├── ui.js            # UI 渲染、图表初始化、交互逻辑
├── api.js           # SillyTavern API 接口调用
├── logger.js        # 日志工具
├── config.js        # 配置常量
└── styles.css       # 样式与主题定义

dist/
└── index.js         # 编译后的打包文件（部署使用）

manifest.json        # 扩展元数据
package.json         # 项目配置与依赖
webpack.config.js    # Webpack 构建配置
```

## 技术栈

- **前端框架**：无框架依赖（原生 JS + jQuery）
- **可视化**：Chart.js（图表库）
- **导出**：html2canvas（页面截图）
- **打包**：Webpack 5
- **样式**：原生 CSS + CSS 变量（主题系统）

## 常见问题

### Q: 时长数据总显示 0 分钟？
A: 确保已刷新统计数据。旧缓存可能缺少时长字段，点击"立即清理"按钮清理过期缓存。

### Q: 导出图片为什么是空白？
A: 确保统计面板完全加载。若仍然出现问题，尝试关闭浏览器插件或使用无痕模式。

### Q: 为什么不同设备上的统计数据不一致？
A: 缓存仅保存在本设备的浏览器中。不同设备需独立分析一次。

### Q: 支持多个 SillyTavern 账户吗？
A: 支持。每个账户的数据独立存储，互不干扰。

### Q: 能否导出为 CSV 格式？
A: 暂不支持。可通过浏览器开发者工具导出控制台的原始数据。

## 已知限制

- 时长统计基于消息估算，不能精确反映真实使用时间
- 缓存数据存储在浏览器本地，清空浏览器数据会导致缓存丢失
- 全局统计模式下，超大量聊天数据（10000+ 条消息）分析可能较慢

## 反馈与贡献

- 💬 [GitHub Issues](https://github.com/Youzini-afk/ST-Statistics/issues) - 问题反馈
- 🔀 [Pull Requests](https://github.com/Youzini-afk/ST-Statistics/pulls) - 代码贡献
- 📧 欢迎提交建议和改进方案

## 许可证

AGPL-3.0-only

本项目采用 AGPL 3.0 协议。如需在商业项目中使用或修改，请详见 [LICENSE](./LICENSE) 文件。

## 更新日志

### v1.0.0 (2026-02-03)
- ✅ 初始版本发布
- ✅ 完成核心统计功能
- ✅ 实现 5 种主题与切换
- ✅ 添加缓存与清理机制
- ✅ 支持日期范围筛选
- ✅ 一键导出图片
